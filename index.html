<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運動資訊統整器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            padding-bottom: 80px;
        }
        .active-tab { color: #2563eb; }
        .hidden { display: none; }
        .calendar-dot { height: 6px; width: 6px; border-radius: 50%; display: inline-block; margin-top: 4px; }
        /* 橘色：訓練，綠色：比賽 */
        .bg-training { background-color: #f97316; }
        .bg-match { background-color: #22c55e; }
        .text-training { color: #f97316; }
        .text-match { color: #22c55e; }
        
        .day-card {
            transition: all 0.2s;
        }
        .day-active {
            border-color: #2563eb;
            background-color: #eff6ff;
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <!-- App Header -->
    <header class="bg-blue-600 text-white p-4 sticky top-0 z-10 shadow-md flex justify-between items-center">
        <div class="w-6"></div>
        <h1 id="page-title" class="text-xl font-bold text-center">總覽</h1>
        <div class="w-6"></div>
    </header>

    <main class="p-4">
        <!-- 1. 總覽 (Overview) -->
        <section id="section-overview" class="space-y-6">
            <!-- 週曆區塊 -->
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <h2 class="font-bold mb-4 flex items-center justify-between">
                    <span class="flex items-center"><i data-lucide="calendar" class="w-5 h-5 mr-2 text-blue-600"></i> 本週賽訓簡覽</span>
                    <span id="current-month" class="text-sm text-gray-500 font-normal"></span>
                </h2>
                <div class="grid grid-cols-7 gap-1 text-center" id="week-calendar-grid">
                    <!-- 動態生成週曆 -->
                </div>
                <div class="mt-4 flex space-x-4 text-xs justify-center border-t pt-3">
                    <span class="flex items-center"><span class="w-3 h-3 bg-training rounded-full mr-1"></span> 球隊訓練</span>
                    <span class="flex items-center"><span class="w-3 h-3 bg-match rounded-full mr-1"></span> 比賽賽程</span>
                </div>
            </div>

            <!-- 待完成自主訓練 (New Section) -->
            <div class="bg-white rounded-xl p-4 shadow-sm border-l-4 border-blue-400">
                <h2 class="font-bold mb-3 flex items-center"><i data-lucide="clipboard-list" class="w-4 h-4 mr-2 text-blue-500"></i> 待完成自主訓練</h2>
                <div id="pending-self-training" class="space-y-2">
                    <p class="text-gray-400 text-sm italic text-center py-2">目前沒有進行中的自主訓練</p>
                </div>
            </div>

            <div class="bg-white rounded-xl p-4 shadow-sm">
                <h2 class="font-bold mb-3 flex items-center"><i data-lucide="trending-up" class="w-4 h-4 mr-2 text-red-500"></i> 未來三場賽程</h2>
                <div id="upcoming-matches" class="space-y-3">
                    <p class="text-gray-400 text-sm italic text-center py-2">目前尚無預定賽程</p>
                </div>
            </div>

            <div class="bg-white rounded-xl p-4 shadow-sm">
                <h2 class="font-bold mb-3 flex items-center"><i data-lucide="history" class="w-4 h-4 mr-2 text-orange-500"></i> 最近訓練日期</h2>
                <ul id="recent-training" class="space-y-2 text-sm text-gray-600">
                    <p class="text-gray-400 italic text-sm text-center py-2">尚無訓練紀錄</p>
                </ul>
            </div>
        </section>

        <!-- 2. 球隊訓練 (Team Training) -->
        <section id="section-team" class="hidden space-y-4">
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <h3 class="font-bold mb-4 text-orange-600">新增訓練計畫</h3>
                <div class="space-y-3">
                    <input type="date" id="team-date" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-orange-500 outline-none">
                    <input type="time" id="team-time" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-orange-500 outline-none">
                    <input type="text" id="team-location" placeholder="訓練地點 (例: 天母棒球場)" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-orange-500 outline-none">
                    <button onclick="addTeamTraining()" class="w-full bg-orange-500 text-white py-3 rounded-lg font-bold shadow-lg active:scale-95 transition-transform">發布訓練通知</button>
                </div>
            </div>
            <div id="team-list" class="space-y-3"></div>
        </section>

        <!-- 3. 比賽賽程 (Matches) -->
        <section id="section-match" class="hidden space-y-4">
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <h3 class="font-bold mb-4 text-green-600">新增比賽資訊</h3>
                <div class="space-y-3 text-sm">
                    <input type="date" id="match-date" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-green-500 outline-none">
                    <input type="time" id="match-time" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-green-500 outline-none">
                    <input type="text" id="match-location" placeholder="比賽地點" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-green-500 outline-none">
                    <input type="text" id="match-opponent" placeholder="對戰對手球隊名稱" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-green-500 outline-none">
                    <button onclick="addMatch()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold shadow-lg active:scale-95 transition-transform">儲存比賽行程</button>
                </div>
            </div>
            <div id="match-list" class="space-y-3"></div>
        </section>

        <!-- 4. 自主訓練 (Self Training) -->
        <section id="section-self" class="hidden space-y-4">
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <h3 class="font-bold mb-2 text-blue-600">上傳訓練課表圖片</h3>
                <p class="text-xs text-gray-500 mb-4 font-normal">AI 將分析課表並列出 (一) 至 (六) 項訓練清單</p>
                <input type="file" id="self-upload" accept="image/*" class="hidden" onchange="processTrainingImage(event)">
                <label for="self-upload" class="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-xl p-6 cursor-pointer hover:bg-gray-50 transition-colors">
                    <i data-lucide="image-plus" class="w-10 h-10 text-gray-400 mb-2"></i>
                    <span class="text-sm text-gray-600 font-medium">點擊上傳課表照片</span>
                </label>
            </div>

            <div id="ai-loading" class="hidden flex items-center justify-center p-4 bg-blue-50 rounded-xl">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <span class="ml-3 text-sm text-blue-700 font-medium font-bold">AI 正在辨識訓練項目...</span>
            </div>

            <div id="self-training-records" class="space-y-4"></div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around items-center py-3 shadow-[0_-4px_10px_rgba(0,0,0,0.05)] z-20">
        <button onclick="switchTab('overview')" id="nav-overview" class="flex flex-col items-center active-tab">
            <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1 font-bold">總覽</span>
        </button>
        <button onclick="switchTab('team')" id="nav-team" class="flex flex-col items-center text-gray-400">
            <i data-lucide="users" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1 font-bold">球隊訓練</span>
        </button>
        <button onclick="switchTab('match')" id="nav-match" class="flex flex-col items-center text-gray-400">
            <i data-lucide="trophy" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1 font-bold">比賽賽程</span>
        </button>
        <button onclick="switchTab('self')" id="nav-self" class="flex flex-col items-center text-gray-400">
            <i data-lucide="dumbbell" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1 font-bold">自主訓練</span>
        </button>
    </nav>

    <script>
        // --- 狀態管理 ---
        let teamSessions = [];
        let matches = [];
        let latestSelfTraining = null; // 儲存最新一次自主訓練的狀態
        const apiKey = ""; 

        // --- 初始化 ---
        window.onload = () => {
            lucide.createIcons();
            renderWeekCalendar();
            updateOverview();
        };

        // --- 導覽切換 ---
        function switchTab(tab) {
            const sections = ['overview', 'team', 'self', 'match'];
            const titles = { overview: '總覽', team: '球隊訓練', self: '自主訓練', match: '比賽賽程' };
            
            sections.forEach(s => {
                document.getElementById(`section-${s}`).classList.add('hidden');
                document.getElementById(`nav-${s}`).classList.remove('active-tab', 'text-gray-400');
                document.getElementById(`nav-${s}`).classList.add('text-gray-400');
            });

            document.getElementById(`section-${tab}`).classList.remove('hidden');
            document.getElementById(`nav-${tab}`).classList.add('active-tab');
            document.getElementById(`page-title`).innerText = titles[tab];
            
            if (tab === 'overview') {
                renderWeekCalendar();
                updateOverview();
            }
            lucide.createIcons();
        }

        // --- 工具：Google 地圖連結 ---
        function getMapUrl(location) {
            return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`;
        }

        // --- 功能：球隊訓練 ---
        function addTeamTraining() {
            const date = document.getElementById('team-date').value;
            const time = document.getElementById('team-time').value;
            const loc = document.getElementById('team-location').value;

            if (!date || !loc) return;

            const session = { id: Date.now(), date, time, location: loc };
            teamSessions.unshift(session);
            renderTeamList();
            renderWeekCalendar();
            
            document.getElementById('team-location').value = "";
            document.getElementById('team-date').value = "";
            document.getElementById('team-time').value = "";
        }

        function renderTeamList() {
            const list = document.getElementById('team-list');
            list.innerHTML = teamSessions.map(s => `
                <div class="bg-white rounded-xl p-4 shadow-sm border-l-4 border-orange-500 animate-fade-in">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-xs text-gray-500">${s.date} ${s.time}</div>
                            <div class="font-bold text-lg">${s.location}</div>
                        </div>
                        <a href="${getMapUrl(s.location)}" target="_blank" class="text-blue-600 bg-blue-50 p-2 rounded-full">
                            <i data-lucide="map-pin" class="w-5 h-5"></i>
                        </a>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // --- 功能：比賽賽程 ---
        async function fetchTeamInfo(teamName) {
            return `來自 ${teamName} 的資訊：該隊目前為該層級的前段班，防守侵略性強。`;
        }

        async function addMatch() {
            const date = document.getElementById('match-date').value;
            const time = document.getElementById('match-time').value;
            const loc = document.getElementById('match-location').value;
            const opp = document.getElementById('match-opponent').value;

            if (!date || !opp) return;

            const info = await fetchTeamInfo(opp);
            const match = { id: Date.now(), date, time, location: loc, opponent: opp, info };
            matches.unshift(match);
            renderMatchList();
            renderWeekCalendar();

            document.getElementById('match-opponent').value = "";
            document.getElementById('match-date').value = "";
            document.getElementById('match-location').value = "";
        }

        function renderMatchList() {
            const list = document.getElementById('match-list');
            list.innerHTML = matches.map(m => `
                <div class="bg-white rounded-xl p-4 shadow-sm border-l-4 border-green-500 animate-fade-in">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="text-xs text-gray-500">${m.date} ${m.time}</div>
                            <div class="font-bold text-lg text-green-700">VS ${m.opponent}</div>
                        </div>
                        <a href="${getMapUrl(m.location)}" target="_blank" class="text-blue-600 bg-blue-50 p-2 rounded-full">
                            <i data-lucide="map-pin" class="w-5 h-5"></i>
                        </a>
                    </div>
                    <div class="text-[11px] bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <strong class="text-gray-700">情報：</strong> ${m.info}
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // --- 功能：自主訓練 (AI 分析) ---
        async function processTrainingImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('ai-loading').classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Data = e.target.result.split(',')[1];
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: "請分析這張訓練課表圖片。請列出訓練日期，並從圖片中擷取出『六個主要訓練項目』。請嚴格按照 (一) 到 (六) 的格式編號這些項目。請以 JSON 回覆：date (字串), summary (字串), items (包含六個字串的陣列)。" },
                                    { inlineData: { mimeType: "image/png", data: base64Data } }
                                ]
                            }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    const result = await response.json();
                    const analysis = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    // 初始化課表狀態
                    latestSelfTraining = {
                        date: analysis.date,
                        items: analysis.items.slice(0, 6).map((text, idx) => ({
                            id: idx,
                            text: text.startsWith(`(${(['一','二','三','四','五','六'])[idx]})`) ? text : `(${(['一','二','三','四','五','六'])[idx]}) ${text}`,
                            completed: false
                        }))
                    };
                    
                    renderSelfTrainingBlock();
                } catch (error) {
                    console.error("AI Analysis failed", error);
                    const defaultItems = ["基礎體能與伸展", "專項肌力訓練", "爆發力訓練", "核心穩定練習", "敏捷性與步伐", "恢復性收操"];
                    latestSelfTraining = {
                        date: new Date().toLocaleDateString('zh-TW'),
                        items: defaultItems.map((text, idx) => ({
                            id: idx,
                            text: `(${(['一','二','三','四','五','六'])[idx]}) ${text}`,
                            completed: false
                        }))
                    };
                    renderSelfTrainingBlock();
                } finally {
                    document.getElementById('ai-loading').classList.add('hidden');
                    event.target.value = '';
                }
            };
            reader.readAsDataURL(file);
        }

        function toggleTask(id) {
            if (!latestSelfTraining) return;
            const task = latestSelfTraining.items.find(i => i.id === id);
            if (task) {
                task.completed = !task.completed;
                renderSelfTrainingBlock();
                // 如果目前在總覽，也要更新
                if (!document.getElementById('section-overview').classList.contains('hidden')) {
                    updateOverview();
                }
            }
        }

        function renderSelfTrainingBlock() {
            const container = document.getElementById('self-training-records');
            if (!latestSelfTraining) return;

            const html = `
                <div class="bg-white rounded-xl p-4 shadow-sm border-t-4 border-blue-500 animate-fade-in">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-blue-700">${latestSelfTraining.date} 訓練進度</h4>
                    </div>
                    <div class="space-y-2">
                        ${latestSelfTraining.items.map(item => `
                            <label class="flex items-center space-x-3 p-3 ${item.completed ? 'bg-gray-100 opacity-60' : 'bg-gray-50'} rounded-lg transition-all">
                                <input type="checkbox" onchange="toggleTask(${item.id})" ${item.completed ? 'checked' : ''} class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="text-sm font-medium ${item.completed ? 'line-through text-gray-400' : 'text-gray-700'}">${item.text}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
            container.innerHTML = html;
            lucide.createIcons();
        }

        // --- 功能：週曆渲染與總覽更新 ---
        function renderWeekCalendar() {
            const grid = document.getElementById('week-calendar-grid');
            const monthLabel = document.getElementById('current-month');
            grid.innerHTML = "";
            
            const today = new Date();
            const currentDay = today.getDay();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - currentDay);
            
            monthLabel.innerText = `${startOfWeek.getFullYear()} / ${startOfWeek.getMonth() + 1}月`;
            const dayNames = ['日', '一', '二', '三', '四', '五', '六'];

            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const dateStr = `${day.getFullYear()}-${String(day.getMonth() + 1).padStart(2, '0')}-${String(day.getDate()).padStart(2, '0')}`;
                const hasTeam = teamSessions.some(s => s.date === dateStr);
                const hasMatch = matches.some(m => m.date === dateStr);
                const isToday = day.toDateString() === today.toDateString();

                grid.innerHTML += `
                    <div class="day-card flex flex-col items-center p-2 rounded-xl border ${isToday ? 'day-active border-blue-200' : 'border-transparent'}">
                        <span class="text-[10px] text-gray-400 mb-1 font-bold">${dayNames[i]}</span>
                        <span class="text-sm font-bold ${isToday ? 'text-blue-600' : 'text-gray-700'}">${day.getDate()}</span>
                        <div class="flex flex-col gap-1 mt-1">
                            ${hasTeam ? '<div class="calendar-dot bg-training"></div>' : '<div class="h-[6px]"></div>'}
                            ${hasMatch ? '<div class="calendar-dot bg-match"></div>' : '<div class="h-[6px]"></div>'}
                        </div>
                    </div>
                `;
            }
        }

        function updateOverview() {
            // 1. 更新待完成自主訓練
            const pendingContainer = document.getElementById('pending-self-training');
            if (latestSelfTraining) {
                const pendingTasks = latestSelfTraining.items.filter(i => !i.completed);
                if (pendingTasks.length > 0) {
                    pendingContainer.innerHTML = pendingTasks.map(task => `
                        <div class="flex items-center text-sm p-2 bg-blue-50 rounded-lg text-blue-800 font-medium animate-fade-in">
                            <i data-lucide="circle" class="w-3 h-3 mr-2 text-blue-400"></i>
                            ${task.text}
                        </div>
                    `).join('');
                } else {
                    pendingContainer.innerHTML = `
                        <div class="flex flex-col items-center py-2 animate-fade-in">
                            <i data-lucide="check-circle-2" class="w-8 h-8 text-green-500 mb-1"></i>
                            <p class="text-green-600 text-sm font-bold">今日課表已全數完成！</p>
                        </div>
                    `;
                }
            }

            // 2. 更新比賽
            const matchBrief = document.getElementById('upcoming-matches');
            if (matches.length > 0) {
                matchBrief.innerHTML = matches.slice(0, 3).map(m => `
                    <div class="flex justify-between items-center border-b border-gray-50 pb-2 text-sm animate-fade-in">
                        <span class="font-medium">${m.date} <b class="text-green-600 ml-1">VS ${m.opponent}</b></span>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                    </div>
                `).join('');
            } else {
                matchBrief.innerHTML = '<p class="text-gray-400 text-sm italic text-center py-2">目前尚無預定賽程</p>';
            }

            // 3. 更新最近訓練日期
            const trainBrief = document.getElementById('recent-training');
            if (teamSessions.length > 0) {
                trainBrief.innerHTML = teamSessions.slice(0, 3).map(s => `
                    <li class="flex items-center text-gray-600 py-1 font-medium animate-fade-in">
                        <span class="w-2 h-2 bg-orange-500 rounded-full mr-3"></span>
                        ${s.date.split('-').slice(1).join('/')} - ${s.location}
                    </li>
                `).join('');
            } else {
                trainBrief.innerHTML = '<p class="text-gray-400 italic text-sm text-center py-2">尚無訓練紀錄</p>';
            }
            lucide.createIcons();
        }
    </script>
</body>
</html>